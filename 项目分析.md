## 项目分析：cc-3

这是一个**LangGraph 编排 + Claude Code CLI 执行**的 AI Agent 框架，当前处于 MVP 阶段（v0.1.0）。

---

### 核心架构

项目采用了清晰的分层设计：

```
用户层 (CLI / FastAPI / React 前端)
        ↓
会话管理层 (SessionManager)
        ↓
编排层 (LangGraph: Planner → Exec → END)
        ↓
执行层 (ClaudeCliExecutor)
        ↓
Claude Code CLI (外部子进程)
```

**核心思路**：LangGraph 不直接执行 bash/grep 等操作，而是负责上层策略（规划/路由/策略/审计），把实际执行交给 Claude Code CLI 子进程。每个 step 启动一次 `claude` 进程，通过 `stream-json` 事件流解析拿结果和 `session_id`，支持 `--resume`/`--fork-session`。

---

### 项目结构总览

| 目录/文件 | 说明 |
|---|---|
| `src/cc3/` | 核心库（13个模块） |
| `src/cc3/orchestrator/` | LangGraph 编排图 |
| `agents/demo/` | 示例 Agent 配置（agent.yaml / system_prompt / policies） |
| `apps/chat_api/` | FastAPI 后端 REST API + SSE |
| `apps/chat_frontend/` | React + Vite 前端 |
| `tests/` | 单元测试（5个测试文件） |
| `main.py` | 入口 shim（不安装也可运行） |

---

### 核心模块解析

| 模块 | 职责 |
|---|---|
| `cli.py` | Typer CLI，提供 `init-agent` 和 `run` 命令 |
| `executor.py` | 核心执行器，spawn Claude CLI 子进程，解析事件流，写入 artifacts |
| `claude_cmd.py` | 构建 `claude` 命令行参数，映射安全策略到工具集 |
| `stream_parser.py` | NDJSON 流解析器 |
| `events.py` | 事件归一化（init/delta/result/error），提取 session_id 等 |
| `session.py` | 会话管理，持久化 `claude_session_id` |
| `locking.py` | 基于 `filelock` 的 workspace 级文件锁 |
| `scaffold.py` | 脚手架，生成 agent + workspace 目录结构 |
| `config.py` | 加载 `agent.yaml` 和 `.env` 配置 |
| `paths.py` | 路径工具（repo root / agent dir / workspace dir） |
| `runner.py` | 面向服务端的 library 入口，供 chat_api 调用 |
| `orchestrator/graph.py` | LangGraph 最小图：Planner → Exec → END |

---

### 安全策略设计

三级权限控制，通过 `--mode` 参数切换：

- **safe**：只允许 Read/Grep/Glob（只读）
- **dev**：允许 Edit/Write/Bash，限制在 workspace 内
- **open**：允许 WebFetch/WebSearch（联网）

---

### 可观测性

每次执行产出完整 artifacts 到 `workspaces/<agent>/runs/<run_id>/`：

- `events.ndjson` — 原始事件流（最重要）
- `events_norm.ndjson` — 归一化事件
- `meta.json` — 运行元信息（耗时/exit_code/session_id）
- `result.txt` — 最终输出
- `step.json` — step 摘要
- `stderr.log` — 错误日志

---

### 测试覆盖

5 个测试文件覆盖了核心模块（NDJSON 解析、事件归一化、锁行为、session 读写、executor artifacts），但**缺少集成测试和 API 测试**。

---

### 应用层（apps/）

已有一个完整的 Chat 应用原型：
- **后端**（`chat_api`）：FastAPI，支持 REST + SSE 实时事件推送，管理对话和消息
- **前端**（`chat_frontend`）：React + Vite，调用后端 API

---

### 评估与建议

**亮点**：
1. 架构分层清晰，编排与执行解耦
2. Session 续接/分支设计合理（resume/fork）
3. 可观测性做得很好（完整事件归档）
4. 安全策略三档设计实用

**待改进**：
1. LangGraph 图目前只有 Planner → Exec → END 单步，缺少 Verifier/Reflect 闭环
2. README 为空，缺乏文档
3. 没有集成测试，chat_api 也没有测试
4. `apps/chat_api` 的依赖管理独立于主项目（单独的 requirements.txt），可考虑统一
5. 缺少 Docker/容器化部署方案
6. Memory 节点尚未实现（设计文档中有规划）

总体来说，这是一个设计思路非常清晰的 MVP，核心管道（CLI → Executor → LangGraph → Session）已经跑通，下一步重点是增强编排能力（多步骤、反思、记忆）和完善应用层。