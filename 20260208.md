# 2026-02-09 开发记录（cc-3 MVP）

本次实现按照 `design.md` 的架构目标完成了一个最小可用版本（MVP）：
- LangGraph 负责编排（Plan/Router/Policy/审计框架），不直接执行 bash/grep。
- Claude Code CLI 作为执行层（hands），每个 step 启动一次 `claude` 子进程，通过 `stream-json` 事件流解析来拿到结果与 `session_id`，并支持 `--resume`/`--fork-session`。

## 已实现功能

### 1) 项目结构与依赖
- 新增 `src/cc3/` 包结构，并保留根目录 `main.py` 作为运行 shim（自动把 `src/` 加入 `sys.path`），方便不安装也能直接运行。
- `pyproject.toml` 增加了 setuptools 构建配置，并定义了脚本入口 `cc3 = "cc3.cli:main"`（安装后可用）。

相关文件：
- `pyproject.toml`
- `src/cc3/__init__.py`
- `src/cc3/__main__.py`
- `main.py`

### 2) 脚手架：init-agent
实现 `init-agent <agent_id>`，会在仓库根目录生成如下结构（符合 `design.md` 推荐）：
- `agents/<agent_id>/agent.yaml`
- `agents/<agent_id>/system_prompt.md`（要求“先检索再回答 + 引用 path:line”）
- `agents/<agent_id>/policies.md`
- `agents/<agent_id>/skills/`
- `workspaces/<agent_id>/.env`
- `workspaces/<agent_id>/kb/`
- `workspaces/<agent_id>/runs/`

相关文件：
- `src/cc3/scaffold.py`
- `src/cc3/cli.py`

### 3) 会话管理与锁
- `workspaces/<agent_id>/session.json` 持久化 `claude_session_id`（下次运行自动续接）。
- 执行前获取 workspace 级别文件锁，避免并发污染。

相关文件：
- `src/cc3/session.py`
- `src/cc3/locking.py`

### 4) Claude CLI Executor（核心）
- 每次执行都会 spawn Claude Code CLI：
  - 固定参数：`claude -p --verbose --output-format stream-json`
  - 默认 `--permission-mode dontAsk`
  - 支持：
    - `--resume <session_id>`（续接会话）
    - `--fork-session`（配合 resume 做 what-if 分支）
- 默认通过 `--add-dir` 授权 Claude CLI 访问：
  - workspace 本身 + `kb/`
  - 当前仓库根目录（避免复制 repo 到 workspace）
- 解析 `stream-json` 的 NDJSON 输出：
  - 原样落盘 `events.ndjson`（最重要的可观测性产物）
  - 同时生成简化的 `events_norm.ndjson`（用于提取 session_id、delta、result_text、apiKeySource 等）
- 每次 run 输出目录：`workspaces/<agent_id>/runs/<run_id>/`
  - `events.ndjson`
  - `events_norm.ndjson`
  - `meta.json`（argv/cwd/耗时/exit_code/session_id 等）
  - `result.txt`（最终输出）
  - `step.json`（本 step 输入输出摘要）
  - `stderr.log`

相关文件：
- `src/cc3/executor.py`
- `src/cc3/claude_cmd.py`
- `src/cc3/stream_parser.py`
- `src/cc3/events.py`

### 5) LangGraph 编排（1-step MVP）
- 实现最小图：`Planner -> Exec -> END`
  - Planner：直接把 goal 当作 instruction（单步执行）
  - Exec：调用 ClaudeCliExecutor，回填 session_id / run_dir / final_text

相关文件：
- `src/cc3/orchestrator/graph.py`

### 6) CLI 命令
目前提供：
- `init-agent`
- `run`

相关文件：
- `src/cc3/cli.py`

## 测试与验证

### 单元测试
- 增加 `tests/` 覆盖：
  - NDJSON 解析
  - 事件归一化/字段提取
  - 锁行为
  - session.json 读写
  - executor 写入 artifacts（通过 monkeypatch subprocess.POpen 模拟）
- 由于环境里 pytest 插件（langsmith）与依赖冲突，运行测试时使用禁用自动插件加载：
  - `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q`

相关文件：
- `pytest.ini`
- `tests/`

### 手动 smoke test
- 可在不安装的情况下直接：
  - `python main.py --help`
  - `python main.py init-agent demo`
  - `python main.py run -a demo --mode safe --goal "..."`

## 其他改动
- 更新 `.gitignore`：忽略 `workspaces/`（包含 secrets/logs）、`.pytest_cache/`、`venv/` 等。

相关文件：
- `.gitignore`
